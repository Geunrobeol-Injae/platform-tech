
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/tracking.css">
    <script src="/js/sockjs.min.js"></script>
    <script src="/js/stomp.min.js"></script>
</head>
<body>
<div id="fixed-dot-container">
    <!-- 위치 변경 -->
    <div class="fixed-dot" style="left: 49px;top: 123px;">스캐너</div>
    <div class="fixed-dot" style="left: 182px;top: 104px;">스캐너</div>
    <div class="fixed-dot" style="left: 253px;top: 61px;">스캐너</div>
    <div class="fixed-dot" style="left: 183px;top: -5px;">스캐너</div>
</div>
<div id="canvas"></div>


<div id="data-container">
    <div class="table-container" id="scanner-data-container">
        <table id="scanner-table">
            <thead>
                <tr>
                    <th>beaconId</th>
                    <th>RSSI A</th>
                    <th>RSSI B</th>
                    <th>RSSI C</th>
                    <th>RSSI D</th>
                </tr>
            </thead>
            <tbody id="scanner-tbody">
                <!-- 스캐너 데이터 -->
            </tbody>
        </table>
    </div>
    <div class="table-container" id="position-data-container">
        <table id="position-table">
            <thead>
                <tr>
                    <th>NAME</th>
                    <th>X</th>
                    <th>Y</th>
                </tr>
            </thead>
            <tbody>
                <!-- 위치 데이터 -->
            </tbody>
        </table>
    </div>
</div>


<script src="/js/tracking.js"></script>

<script>
    function stompClient(endpoint, destination, callback) {
        var socket = new SockJS(endpoint);
        var stompClient = Stomp.over(socket);
    
        stompClient.connect({}, function(frame) {
            stompClient.subscribe(destination, callback);
        });
    
        return stompClient;
    }
    
    const posClient = stompClient("/ws", "/loc/pos", (message) => {
    var data = JSON.parse(message.body);
    updatePositionTable(data);
    });


    function updatePositionTable(data) {
            var positionTable = document.getElementById("position-table");
            var tbody = positionTable.querySelector("tbody");

            data.forEach(item => {
                var pseudonym = item.pseudonym || "N/A";
                var existingRow = findRowByPseudonym(tbody, pseudonym);
                if (existingRow) {
                    // 기존 행 업데이트
                    existingRow.cells[1].textContent = item.pos.x;
                    existingRow.cells[2].textContent = item.pos.y;
                } else {
                    // 새 행 추가
                    var row = tbody.insertRow();
                    row.insertCell().textContent = pseudonym; // 이름
                    row.insertCell().textContent = item.pos.x; // X 좌표
                    row.insertCell().textContent = item.pos.y; // Y 좌표
                }
            });
        }

    function findRowByPseudonym(tbody, pseudonym) {
        for (var i = 0; i < tbody.rows.length; i++) {
            if (tbody.rows[i].cells[0].textContent === pseudonym) {
               return tbody.rows[i];
            }
        }
        return null;
    }


    var scannerData = {};

    function updateScannerData(message) {
        var data = JSON.parse(message.body);
        data.beacons.forEach(beacon => {
            if (!scannerData[beacon.beaconId]) {
                scannerData[beacon.beaconId] = { 'RSSI A': '', 'RSSI B': '', 'RSSI C': '', 'RSSI D': '' };
            }
            scannerData[beacon.beaconId]['RSSI ' + data.scannerId.split('-')[1]] = beacon.rssi;
        });
        updateScannerTable();
    }

    function updateScannerTable() {
        var scannerTable = document.getElementById("scanner-table");
        var tbody = scannerTable.querySelector("tbody");

        tbody.innerHTML = ''; // 기존 데이터 초기화

        Object.keys(scannerData).forEach(beaconId => {
            var row = tbody.insertRow();
            row.insertCell().textContent = beaconId;
            row.insertCell().textContent = scannerData[beaconId]['RSSI A'];
            row.insertCell().textContent = scannerData[beaconId]['RSSI B'];
            row.insertCell().textContent = scannerData[beaconId]['RSSI C'];
            row.insertCell().textContent = scannerData[beaconId]['RSSI D'];
        });
    }

    const scClient = stompClient("/ws", "/loc/sc", (message) => {
        updateScannerData(message);
    });


</script>




</body>
</html>
